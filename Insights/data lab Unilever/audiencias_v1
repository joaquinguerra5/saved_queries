DECLARE date_filter DATE DEFAULT DATE_SUB(CURRENT_DATE(),INTERVAL 30 DAY);

CREATE OR REPLACE TABLE `peya-food-and-groceries.user_joaquin_guerra.temp_datalab_audiencias`

--PARTITION BY report_period

AS

--INSERT INTO `peya-food-and-groceries.automated_tables_reports.ms_insights_datalab_marketshare_ar`
WITH orders AS
(SELECT
    report_period as report_period,
    DATE_TRUNC(report_period,MONTH) as month,
    DATE_TRUNC(report_period,WEEK) as week,
    EXTRACT(DAYOFWEEK FROM report_period) as day_of_week,
    hour_part,
    country_name,
    dp.city.name AS city_name,
    c.latitude,
    c.longitude,
    CASE 
      WHEN dip.is_dmart THEN 'Dmart' 
      WHEN aaa.partner_id IS NOT NULL THEN 'AAA' 
      ELSE 'Local Shops'
    END AS tipo_tienda,
    product_cpg,
    product_brand,
    dip.product_name,
    dip.barcodes,
    dvps.master_category_names.level_one as master_category_lvl_one,
    dvps.master_category_names.level_two as master_category_lvl_two,
    dvps.master_category_names.level_three as master_category_lvl_three,
    dvps.master_category_names.level_four as master_category_lvl_four,
    dip.order_id,
    ui.user_id,
    ui.gender_merged,
    ui.dh_gender_prediction,
    ui.age_group_merged,
    ui.cell_segment,
    ui.income,
    ui.income_old,
    ui.segment,
    ui.user_demographic_group,
    ui.subsegment,
    dp.is_plus,
    COALESCE(total_price_eur,0) AS gmv_eu,
    COALESCE(total_price_lc,0) AS gmv_lc,
    COALESCE(quantity,0) as quantity,
  FROM `peya-bi-tools-pro.il_qcommerce.partnership_orders_dip` dip
  LEFT JOIN
    (SELECT DISTINCT registered_date,order_id, user.id as user_id  FROM `peya-bi-tools-pro.il_core.fact_orders` ) o
  ON
    SAFE_CAST(o.order_id AS STRING) = dip.order_id AND o.registered_date = dip.report_period
  LEFT JOIN
    `peya-bi-tools-pro.il_qcommerce.dim_vendor_product_snapshot` dvps
  ON
    SAFE_CAST(dvps.remote_vendor_id AS STRING) = dip.platform_vendor_id AND dvps.sku = dip.sku
  LEFT JOIN
    `peya-bi-tools-pro.il_core.dim_partner` dp
  ON
    SAFE_CAST(dp.partner_id AS STRING) = dip.platform_vendor_id
  LEFT JOIN 
    `peya-food-and-groceries.automated_tables_reports.partners_aaa_snapshot` aaa
  ON
    SAFE_CAST(aaa.partner_id AS STRING) = dip.platform_vendor_id AND aaa.snapshot_date = dip.report_period
  LEFT JOIN
    `peya-bi-tools-pro.il_core.dim_city` c
  ON
    c.city_id = dp.city_id AND dp.country.country_name = c.country.country_name
  LEFT JOIN
    `peya-bi-tools-pro.il_growth.user_income` ui
  ON
    o.user_id = ui.user_id
  WHERE
    country_name = 'Argentina'
      AND  
    report_period >= date_filter
      AND
    dip.quantity > 0
    AND
      dvps.snapshot_date >= date_filter
  GROUP BY
    ALL
)

SELECT
  *,
  CASE
    WHEN day_of_week = 1 THEN 'DOMINGO'
    WHEN day_of_week = 2 THEN 'LUNES'
    WHEN day_of_week = 3 THEN 'MARTES'
    WHEN day_of_week = 4 THEN 'MIERCOLES'
    WHEN day_of_week = 5 THEN 'JUEVES'
    WHEN day_of_week = 6 THEN 'VIERNES'
    ELSE 'SABADO'
  END as dia_semana,
  SUM(quantity) OVER(PARTITION BY order_id) as basket_size,
  SUM(gmv_eu) OVER(PARTITION BY order_id) as basket_value_eu,
  SUM(gmv_lc) OVER(PARTITION BY order_id) as basket_value_lc,
FROM
  orders