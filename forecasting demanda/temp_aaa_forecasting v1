DECLARE date_from DATE DEFAULT '2024-01-01';
DECLARE date_to DATE DEFAULT CURRENT_DATE();


-- CREATE OR REPLACE TABLE `peya-food-and-groceries.user_joaquin_guerra.temp_aaa_forecasting`

-- PARTITION BY timestamp

-- CLUSTER BY
--  partner_id

-- AS

WITH partners AS (
  SELECT
    partner_id,
    MIN(snapshot_date) as min_snapshot_date,
    MAX(snapshot_date) as max_snapshot_date
  FROM
    `peya-food-and-groceries.automated_tables_reports.partners_aaa_snapshot` aaa
  WHERE
    snapshot_date >= date_from
  GROUP BY
    ALL
),

partner_dates AS (
  SELECT
    partner_id,
    day
  FROM
    partners,
    UNNEST(GENERATE_DATE_ARRAY(min_snapshot_date,max_snapshot_date)) day
)
,

items_ordered AS (
	SELECT
		ops_orders.local_date as date,
    aaa.partner_id,
    SUM(ops_orders.qty_ordered) as qty_ordered
	FROM
		`fulfillment-dwh-production.curated_data_shared_dmart.ls_ops_orders` ops_orders
	INNER JOIN
		`peya-food-and-groceries.automated_tables_reports.partners_aaa_snapshot` aaa
	ON
		SAFE_CAST(aaa.partner_id AS STRING) = ops_orders.vendor_id AND aaa.snapshot_date = ops_orders.local_date
  WHERE
    ops_orders.local_date BETWEEN date_from AND date_to
  GROUP BY
    ALL
)


SELECT
  pd.day as timestamp,
  EXTRACT(day FROM pd.day) as day,
  EXTRACT(ISOWEEK FROM pd.day) as isoweek,
  EXTRACT(month FROM pd.day) as month,
  EXTRACT(year FROM pd.day) as year,
  pd.partner_id,
  aaa.franchise,
  aaa.clasificacion,
  dhp.shopper_type_id,
  dp.country.country_code,
  dp.city.id as city_id,
  COALESCE(COUNT(DISTINCT order_id),0) as order_count,
  COALESCE(ANY_VALUE(qty_ordered),0) as items_ordered,
  COALESCE(ANY_VALUE(COALESCE(GREATEST(availability.ot,0),0)),0) as open_time,
  COALESCE(ANY_VALUE(COALESCE(GREATEST(availability.weighted_open_hours,0),0)),0) as weighted_open_hours,
FROM
  partner_dates pd
LEFT JOIN
  `peya-bi-tools-pro.il_core.fact_orders` fo
ON
  pd.partner_id = fo.restaurant.id AND pd.day = fo.registered_date
INNER JOIN
  `peya-food-and-groceries.automated_tables_reports.partners_aaa_snapshot` aaa
ON
  aaa.partner_id = pd.partner_id AND pd.day = aaa.snapshot_date
LEFT JOIN
  `peya-bi-tools-pro.il_core.dim_partner` dp
ON
  dp.partner_id = pd.partner_id
LEFT JOIN
  `peya-bi-tools-pro.il_core.dim_historical_partners` dhp
ON
  dhp.restaurant_id = pd.partner_id AND dhp.yyyymmdd = pd.day
LEFT JOIN
  items_ordered io
ON
  io.partner_id = pd.partner_id AND io.date = pd.day
LEFT JOIN
  `peya-food-and-groceries.automated_tables_reports.aaa_availability_v4` availability
ON
  availability.partner_id = pd.partner_id AND availability.registered_date = pd.day
WHERE
  pd.day BETWEEN date_from AND date_to
--AND
  --aaa.partner_id = 329470
-- AND
--   day = '2025-01-01'
GROUP BY
  ALL